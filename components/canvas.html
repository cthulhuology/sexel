<script>
  // Define the custom Sexel Canvas component
  Sexel.tag('sexel-canvas', ['width','height','script'], {
    ondraw: (self) => {
      const canvas = self.querySelector('#canvas')
      canvas.innerHTML = ''
      canvas.width = self.width() || 300;
      canvas.height = self.height() || 300;

      // Get the 2D drawing context from the canvas
      const ctx = canvas.getContext('2d');
      const script = self.script()
      
      // Split the script into tokens by whitespace.
      const tokens = script.trim().split(/\s+/);
      const stack = [];

      // Dictionary of commands mapping token names to functions that implement them.
      // Each function pops its required parameters from the stack.
      const commands = {
        // Path commands
        'beginPath': () => ctx.beginPath(),
        'closePath': () => ctx.closePath(),
        'moveTo': () => {
          let y = stack.pop();
          let x = stack.pop();
          ctx.moveTo(x, y);
        },
        'lineTo': () => {
          let y = stack.pop();
          let x = stack.pop();
          ctx.lineTo(x, y);
        },
        // Arc: expects x y radius startAngle endAngle anticlockwise
        'arc': () => {
          let anticlockwise = stack.pop();
          let endAngle = stack.pop();
          let startAngle = stack.pop();
          let radius = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.arc(x, y, radius, startAngle, endAngle, Boolean(anticlockwise));
        },
        // Stroke and fill operations
        'stroke': () => ctx.stroke(),
        'fill': () => ctx.fill(),
        // Rectangle drawing methods
        'fillRect': () => {
          let h = stack.pop();
          let w = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.fillRect(x, y, w, h);
        },
        'strokeRect': () => {
          let h = stack.pop();
          let w = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.strokeRect(x, y, w, h);
        },
        'clearRect': () => {
          let h = stack.pop();
          let w = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.clearRect(x, y, w, h);
        },
        // Drawing a rectangle path
        'rect': () => {
          let h = stack.pop();
          let w = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.rect(x, y, w, h);
        },
        // Text drawing (assumes text, x, y)
        'fillText': () => {
          let text = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.fillText(text, x, y);
        },
        'strokeText': () => {
          let text = stack.pop();
          let y = stack.pop();
          let x = stack.pop();
          ctx.strokeText(text, x, y);
        },
        // Setting properties
        'setFillStyle': () => {
          let style = stack.pop();
          ctx.fillStyle = style;
        },
        'setStrokeStyle': () => {
          let style = stack.pop();
          ctx.strokeStyle = style;
        },
        'setLineWidth': () => {
          let width = stack.pop();
          ctx.lineWidth = width;
        }
        // Add additional commands to fully wrap the HTML5 canvas API as needed.
      };

      // Process each token in sequence.
      tokens.forEach(token => {
        // Check if the token is a number (using a strict regex for a number)
        if (/^-?\d+(\.\d+)?$/.test(token)) {
          stack.push(parseFloat(token));
        }
        // if token is not a command push it, treat it as string data 
        else if (! commands.hasOwnProperty(token)) {
          stack.push(token);
        }
        // Otherwise, if the token matches a known command, execute it
        else if (typeof(commands[token]) == 'function') {
          commands[token]();
        }
        // If the token is not recognized, log a warning
        else {
          console.warn(`Unknown token or command: ${token}`);
        }
      });
    }
  })
</script>

<style>
.sexel-canvas {
	border: none;
	max-width: 100%;
	padding: 0px;
}
</style>
<template id="sexel-canvas">
<canvas class="sexel-canvas" id="canvas"></canvas>
</template>
